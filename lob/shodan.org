* Domain names and IP addresses list

Vstupní tabulka obsahuje seznam domén a jmen v nich.
 #+NAME: domains
 | domain | Subdomény        |
 |--------+------------------|
 | cz     | lupa,root,seznam |
 | nic.cz | ntp,www          |

The table can be expanded to a list:
#+begin_src emacs-lisp :var names=domains :results list
(domainlist-to-dnsnames names)
#+end_src

#+RESULTS:
- cz
- lupa.cz
- root.cz
- seznam.cz

#+NAME: shodan-get-ips
#+begin_src emacs-lisp :var names=domains
  (cl-list* '(name IP) 'hline
	    (cl-sort (resolve-names (domainlist-to-dnsnames names)) 'ip-smaller :key 'cadr))
#+end_src

#+RESULTS: shodan-get-ips
| name       |             IP |
|------------+----------------|
| ntp.nic.cz | 217.31.202.100 |
| www.nic.cz |  217.31.205.50 |
| nic.cz     |  217.31.205.50 |

Get Shodan information on IP addresses:
#+NAME: shodan-get-json
#+begin_src emacs-lisp :var hosts=shodan-get-ips[,1] :results silent
(shodan-get-hosts (cl-remove-duplicates hosts :test 'equal))
#+end_src

** SSL/TLS servery
#+NAME: json-extract
 #+begin_src emacs-lisp :var dir="." :var datapath='ssl
       (cl-list* (cadr (assoc datapath shodan-json-path-alist)) 'hline
		  (mapcar (lambda (a)
			    (cons (car (cl-find (car a) names-cache :key 'cadr :test 'equal)) a))
	  (mapcan (lambda (file)
		    (message "%s" file)
		    (shodan-get-data-from-file file (cddr (assoc datapath shodan-json-path-alist))))
		  (directory-files "." t "\.json$" t))))
 #+end_src

#+RESULTS: json-extract
 | Hostname   |             IP | Port | Subject CN    | Issuer CN                  |
 |------------+----------------+------+---------------+----------------------------|
 | root.cz    | 91.213.160.188 |  443 | root.cz       | Let's Encrypt Authority X3 |
 | lupa.cz    | 91.213.160.123 |  443 | lupa.cz       | Let's Encrypt Authority X3 |
 | seznam.cz  |    77.75.77.53 |  443 | www.seznam.cz | Let's Encrypt Authority X3 |
 | www.nic.cz |  217.31.205.50 |  443 | nic.cz        | Let's Encrypt Authority X3 |

** HTTP servery
#+CALL: json-extract(datapath='http)

#+RESULTS:
| Hostname   |             IP | Port | Reverse       | Title                               | Server                                | Status                         |
|------------+----------------+------+---------------+-------------------------------------+---------------------------------------+--------------------------------|
| root.cz    | 91.213.160.188 |  443 | nil           | Blogy - Root.cz                     | Apache/2.4.25 (Debian) OpenSSL/1.0.2l | HTTP/1.1 200 OK                |
| root.cz    | 91.213.160.188 |   80 | nil           | 301 Moved Permanently               | Apache/2.4.25 (Debian)                | HTTP/1.1 301 Moved Permanently |
| lupa.cz    | 91.213.160.123 |  443 | www.lupa.cz   | Lupa.cz - server o českém Internetu | nginx/1.10.3                          | HTTP/1.1 200 OK                |
| lupa.cz    | 91.213.160.123 |   80 | www.lupa.cz   | 301 Moved Permanently               | nginx/1.10.3                          | HTTP/1.1 301 Moved Permanently |
| seznam.cz  |    77.75.77.53 |  443 | www.seznam.cz | nil                                 | nginx                                 | HTTP/1.1 200 OK                |
| seznam.cz  |    77.75.77.53 |   80 | www.seznam.cz | 302 Found                           | nginx                                 | HTTP/1.1 302 Moved Temporarily |
| www.nic.cz |  217.31.205.50 |  443 | www.nic.cz    | CZ.NIC                              | nginx                                 | HTTP/1.1 200 OK                |
| www.nic.cz |  217.31.205.50 |   80 | www.nic.cz    | 301 Moved Permanently               | nginx                                 | HTTP/1.1 301 Moved Permanently |

** Ne-http servery
#+CALL: json-extract[:eval never](datapath='non-http)
*Lorem* ipsum
#+RESULTS:
| Hostname   |             IP | Port | Protocol | Server | Verze |
|------------+----------------+------+----------+--------+-------|
| ntp.nic.cz | 217.31.202.100 |  123 | ntp      | nil    | nil   |
| ntp.nic.cz | 217.31.202.100 | 5353 | mdns     | nil    | nil   |


* Mapping network
#+begin_src restclient
POST https://api.shodan.io/shodan/alert?key=:key
Content-type: application/json

{
 "name": "Test",
 "filters": {
  "ip": ["194.228.123.0/26"]
 }
}
#+end_src

#+begin_src json
{
  "triggers": null,
  "name": "Test",
  "created": "2019-02-13T13:02:49.721733",
  "expires": 0,
  "expiration": null,
  "filters": {
    "ip": [
      "194.228.123.0/26"
    ]
  },
  "id": "PUMDNLX1BJYIBK4E",
  "size": 64
}
#+end_src

#+begin_src emacs-lisp
(let ((process (open-network-stream "Stream" (switch-to-buffer "*Stream Shodan*")
				    "stream.shodan.io" 443
				    :type 'tls)))
  (comint-mode)
  (set-process-filter (get-process "Stream") 'streaming-filter)
  (comint-send-string process "GET /shodan/alert?key=8wrrcNO8vJfBholM7leWTmnKqtUJ1oCa HTTP/1.1\nHost: stream.shodan.io\n\n"))
#+end_src

#+RESULTS:
#+begin_src emacs-lisp
(defun streaming-filter (proc text)
  (unless (or (equal text "1") (equal text "\n"))
    (internal-default-process-filter proc text)))
#+end_src


** ASN scan (fails)

#+begin_src emacs-lisp
(let ((process (open-network-stream "Stream II" (switch-to-buffer "*Stream Shodan II*")
				    "stream.shodan.io" 443
				    :type 'tls)))
  (comint-mode)
  (set-process-filter (get-process "Stream") 'streaming-filter)
  (comint-send-string process "GET /shodan/asn/48298?key=8wrrcNO8vJfBholM7leWTmnKqtUJ1oCa HTTP/1.1\nHost: stream.shodan.io\n\n"))
#+end_src

#+RESULTS:
